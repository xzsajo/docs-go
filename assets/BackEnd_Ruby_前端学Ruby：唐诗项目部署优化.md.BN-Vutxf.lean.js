import{_ as a,c as i,a3 as t,o as l}from"./chunks/framework.CAwIQbWu.js";const c=JSON.parse('{"title":"前端学 Ruby：唐诗项目部署优化","description":"","frontmatter":{},"headers":[],"relativePath":"BackEnd/Ruby/前端学Ruby：唐诗项目部署优化.md","filePath":"BackEnd/Ruby/前端学Ruby：唐诗项目部署优化.md","lastUpdated":1686444123000}'),e={name:"BackEnd/Ruby/前端学Ruby：唐诗项目部署优化.md"};function n(p,s,h,k,o,r){return l(),i("div",null,s[0]||(s[0]=[t(`<h1 id="前端学-ruby-唐诗项目部署优化" tabindex="-1">前端学 Ruby：唐诗项目部署优化 <a class="header-anchor" href="#前端学-ruby-唐诗项目部署优化" aria-label="Permalink to &quot;前端学 Ruby：唐诗项目部署优化&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>本篇文章和 Ruby 关系不大，只是涉及到部署问题</p><p>前文花了不少时间从零到部署唐诗项目，当时因为篇幅问题留下了不少的坑</p><p>例如可以采用 docker-compose 来代替两个容器互相访问、使用 shell 命令在本地部署，本文并未对其进行改造，因为传统部署 Ruby on Rails 的弊端很明显，需要运维经验。为快速部署 Rails 引用，笔者寻觅到了 fly.io。本文将在唐诗项目基础上将其部署到 fly.io 上</p><h2 id="回顾唐诗-api" tabindex="-1">回顾唐诗 API <a class="header-anchor" href="#回顾唐诗-api" aria-label="Permalink to &quot;回顾唐诗 API&quot;">​</a></h2><ul><li>随机出现一首诗：/poetry/random</li><li>用诗的题目查询：/poetry/title/静夜思</li><li>列出这个诗人的所有诗：/poetry/author/李白</li><li>列出这个诗人的这首诗：/poetry/author/张若虚/title/春江花月夜</li></ul><h2 id="如何启动" tabindex="-1">如何启动 <a class="header-anchor" href="#如何启动" aria-label="Permalink to &quot;如何启动&quot;">​</a></h2><p>先将项目中的 <code>tangpoetry.sql</code> 导入到 postgresql 数据库。可以使用 pgAdmin 也可以使用命令行 psql 导入数据</p><p>再 <code>rails s</code> 启动项目</p><p>检查本地启动没问题后，开始部署项目</p><h2 id="部署项目" tabindex="-1">部署项目 <a class="header-anchor" href="#部署项目" aria-label="Permalink to &quot;部署项目&quot;">​</a></h2><p>官方 <a href="https://fly.io/docs/rails/getting-started/" target="_blank" rel="noreferrer">Rails 部署教程</a> 已经写的很清楚了，可以按照上面的做一遍练练手</p><p>这里我们按照<a href="https://fly.io/docs/hands-on/" target="_blank" rel="noreferrer">亲身体验 Fly.io</a> 来手把手体验 Fly.io</p><h3 id="安装-flyctl" tabindex="-1">安装 flyctl <a class="header-anchor" href="#安装-flyctl" aria-label="Permalink to &quot;安装 flyctl&quot;">​</a></h3><p>安装方式可以参考官方文档：<a href="https://fly.io/docs/hands-on/install-flyctl/" target="_blank" rel="noreferrer">https://fly.io/docs/hands-on/install-flyctl/</a></p><p>因为笔者是 window，可运行以下命令安装</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pwsh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;iwr https://fly.io/install.ps1 -useb | iex&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或者</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">powershell</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;iwr https://fly.io/install.ps1 -useb | iex&quot;</span></span></code></pre></div><p>如果执行 <code>flyctl version</code> 不报错，就说明安装成功了</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">flyctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># flyctl.exe v0.1.32 windows/amd64</span></span></code></pre></div><h3 id="注册-fly-io" tabindex="-1">注册 fly.io <a class="header-anchor" href="#注册-fly-io" aria-label="Permalink to &quot;注册 fly.io&quot;">​</a></h3><p>如果这是您第一次使用 Fly.io，则需要注册一个帐户</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fly</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> auth</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> signup</span></span></code></pre></div><p>注册完之后，登录 fly.io</p><h3 id="登录-fly-io" tabindex="-1">登录 fly.io <a class="header-anchor" href="#登录-fly-io" aria-label="Permalink to &quot;登录 fly.io&quot;">​</a></h3><p>如果您已经拥有 Fly.io 帐户，则只需使用 flyctl 登录即可</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fly auth login</span></span></code></pre></div><h3 id="启动应用程序" tabindex="-1">启动应用程序 <a class="header-anchor" href="#启动应用程序" aria-label="Permalink to &quot;启动应用程序&quot;">​</a></h3><p>先进入我们的 tangpoetry API 项目，在命令行中敲入：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fly</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> launch</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 创建我们的应用</span></span></code></pre></div><p>命令行会提示几个问题：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Creating</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> D:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">orkspace</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">uby</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">angpoetry</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Scanning</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> code</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Detected</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Rails</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Choose an app name (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">leave</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> blank</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> one</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Choose a region </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> deployment: Hong Kong, Hong Kong (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hkg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Would you like to set up a Postgresql database now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Yes</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Select configuration: Development - Single node, 1x shared CPU, 256MB RAM, 1GB disk</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Would you like to set up an Upstash Redis database now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> No</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Create .dockerignore from 1 .gitignore files</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> No</span></span></code></pre></div><p>这里的 app name 将来会是项目的名字，具有唯一性。后面是否创建 postgresql 数据库，笔者直接选择创建数据库，fly.io 创建完数据库后，给在界面上给出数据库的用户名密码等信息。Redis 不需要不用部署</p><p>当命令执行完毕，fly 会创建<code>fly.toml</code> 和 <code>Dockerfile</code> 等文件</p><p><img src="https://s2.loli.net/2023/06/09/gTqBkGl8ZNIMHXJ.png" alt="fly launch完成"></p><p>我们不着急部署，先将数据库导入</p><h3 id="数据库导入" tabindex="-1">数据库导入 <a class="header-anchor" href="#数据库导入" aria-label="Permalink to &quot;数据库导入&quot;">​</a></h3><p>上一步在执行的时候已经帮我们创建了数据库，文档里已经描述了<a href="https://fly.io/docs/postgres/connecting/" target="_blank" rel="noreferrer">如何连接 fly postgres</a>，这里有个坑，比如起初用<code>psql postgres://{username}:{password}@{hostname}:{port}/{database}?options</code> 这种方式连接fly 数据库时就是连接不通。因为 fly.io 做过限制，Fly Postgres 的数据库是内部网络，<strong>默认情况下是不会公开</strong>，所以是连接不上的。我们可以分配 ip 地址，但是这个需要钱，一个月2美元</p><p>当你想分配公共的 ip 地址时：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fly</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ips</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allocate-v4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pg-app-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Looks like you&#39;re accessing a paid feature. Dedicated IPv4 addresses now cost $2/mo. Are you ok with this?</span></span></code></pre></div><p>所以用外部连接的方式行不通，笔者这里采用的是<a href="https://fly.io/docs/flyctl/proxy/" target="_blank" rel="noreferrer"><code>fly proxy</code></a> 将服务器端口转发到本地服务上</p><p>唐诗项目的执行如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fly</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proxy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5433</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tangpoetry-db</span></span></code></pre></div><blockquote><p>因为本地已经开了 5432 的端口，故用 5433 代替</p><p>转发的终端就开着，另起一个终端来进行之后的命令</p></blockquote><p>再通过 psql 连接就能通了</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">psql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;postgres://postgres:&lt;password&gt;@localhost:5433&quot;</span></span></code></pre></div><p>将根目录中的 <code>tangpoetry.sql</code> 导入到 fly postgres 数据库中，查看有数据后，我们进入 <code>config/database.yml</code> ，修改 production 的配置</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">production</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">postgres</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">postgres</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;%= ENV[&quot;DB_PASSWORD&quot;] %&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;%= ENV[&quot;DB_HOST&quot;] %&gt;</span></span></code></pre></div><p>将数据库密码和主机写进 fly secrets 中</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">flyctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secrets</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DB_PASSWORD=DB_PASSWORD</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">flyctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secrets</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DB_PASSWORD=DB_HOST</span></span></code></pre></div><h3 id="部署" tabindex="-1">部署 <a class="header-anchor" href="#部署" aria-label="Permalink to &quot;部署&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fly</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 部署</span></span></code></pre></div><p>笔者这里没有用默认的 Dockerfile，因为就是跑不通，后来自己写了个 Dockerfile 才部署成功</p><p>访问：<a href="https://tangpoetry.fly.dev/poetry/random" target="_blank" rel="noreferrer">https://tangpoetry.fly.dev/poetry/random</a> ，能访问成功了，我们成功了</p><h3 id="别的有用的flyctl-命令" tabindex="-1">别的有用的flyctl 命令 <a class="header-anchor" href="#别的有用的flyctl-命令" aria-label="Permalink to &quot;别的有用的flyctl 命令&quot;">​</a></h3><ul><li>创建 postgresql 数据库：<code>fly pg create</code></li><li>查看 postgresql 数据库列表： <code>fly pg list</code></li><li>通过 ssh 进入您的虚拟机：<code>fly ssh console</code></li><li>查看应用状态: <code>flyctl status</code></li><li>查看应用信息: <code>flyctl info</code></li><li>查看应用列表: <code>flyctl apps list</code></li><li>查看应用的IP: <code>flyctl ips list</code></li><li>销毁某个应用: <code>flyctl apps destroy &lt;appname&gt;</code></li></ul><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>正所谓：别人笑我太疯癫，我笑他人看不穿。这个项目正是无语至极之作品</p><p>项目地址：<a href="https://github.com/johanazhu/tangpoetry" target="_blank" rel="noreferrer">https://github.com/johanazhu/tangpoetry</a></p><p>预览地址：<a href="https://tangpoetry.fly.dev/" target="_blank" rel="noreferrer">https://tangpoetry.fly.dev/</a></p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><ul><li><a href="https://geeknote.net/Rei/posts/387" target="_blank" rel="noreferrer">在 Fly.io 部署 Rails 应用</a></li></ul>`,62)]))}const g=a(e,[["render",n]]);export{c as __pageData,g as default};
